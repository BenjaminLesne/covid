# Ralph Progress Log
Started: Mon Feb  9 14:53:48 CET 2026
---

## Codebase Patterns
- Client-side services go in `src/services/` (NOT `src/server/services/`)
- Use `AbortSignal.timeout(15_000)` for browser fetch timeout (no `next: { revalidate }`)
- CSV parsing uses Papa Parse with `;` delimiter and French locale handling
- Week format normalized from "YYYY-SWW" to "YYYY-WWW"
- DATA_URLS and constants imported from `@/lib/constants`
- Types imported from `@/types/wastewater` and `@/types/clinical`
- When deleting server code, clean `.next` cache first — stale type references in `.next/types/` cause phantom TS errors
- `station-select.tsx` was missed by earlier migrations — always grep for `trpc.` before the final removal story
---

## 2026-02-09 - US-207
- Removed all tRPC infrastructure: server, services, API route, client, and provider wrapper
- Fixed `station-select.tsx` which still had `trpc.wastewater.getStations.useQuery()` — replaced with `useStations()` hook
- Simplified `providers.tsx` to only `QueryClientProvider` + `ThemeProvider` (preserved QueryClient config)
- Deleted: `src/server/trpc/` (4 files), `src/server/services/` (2 files), `src/app/api/trpc/[trpc]/route.ts`, `src/lib/trpc.ts`
- Removed empty `src/server/` directory
- Grep confirms zero remaining `@/lib/trpc`, `@/server/`, or `trpc.` imports
- Typecheck passes (needed `.next` cache clear for stale type refs)
- Pre-existing lint warning in `use-wastewater-data.ts` (React Compiler memoization) — not introduced by this story
- Browser verification: could not verify due to chrome-devtools MCP conflict (manual check needed)
- Files changed: `src/components/filters/station-select.tsx`, `src/components/providers.tsx` + 8 deleted files
- **Learnings for future iterations:**
  - `.next/types/` caches auto-generated types for API routes — after deleting route files, run `rm -rf .next` before `tsc --noEmit`
  - Always grep for ALL tRPC usage (`trpc.`, `@/lib/trpc`, `@/server/`) before starting the removal story — `station-select.tsx` was missed by component migration stories
  - The `getBaseUrl()` helper in providers.tsx was only needed for tRPC — safe to remove along with the tRPC client
---

## 2026-02-09 - US-206
- Replaced `trpc.wastewater.getNationalTrend.useQuery()` with `useNationalTrend()` from new hooks
- Removed `import { trpc }` from severity-summary.tsx
- Loading, error, and data states remain exactly the same
- Files changed: `src/components/severity/severity-summary.tsx`
- Browser verification: could not verify due to chrome-devtools MCP conflict (manual check needed)
- **Learnings for future iterations:**
  - Simplest migration — just swap the import and the hook call, everything else stays identical
  - The `useNationalTrend()` hook returns `{ data, isLoading, isError, refetch }` with the same shape as the tRPC hook
---

## 2026-02-09 - US-205
- Replaced `trpc.wastewater.getStations.useQuery()` and `trpc.wastewater.getIndicators.useQuery()` with `useStations()` and `useIndicators()` from new hooks
- Removed `import { trpc }` from france-map-inner.tsx
- Loading, error, and empty states remain exactly the same
- Files changed: `src/components/map/france-map-inner.tsx`
- Browser verification: could not verify due to chrome-devtools MCP conflict (manual check needed)
- **Learnings for future iterations:**
  - The `enabled: !!stations` pattern from tRPC was dropped — `useIndicators()` fetches independently; React Query deduplication means no extra network request
  - The map component was already partially migrated in a previous working session (uncommitted changes on the branch)
---

## 2026-02-09 - US-204
- Replaced all `trpc.wastewater.*` and `trpc.clinical.*` useQuery calls with new hooks
- Removed `import { trpc }` from wastewater-chart.tsx
- Loading, error, and empty states preserved exactly as before
- Files changed: `src/components/chart/wastewater-chart.tsx`
- Browser verification: could not verify due to chrome-devtools MCP conflict (manual check needed)
- **Learnings for future iterations:**
  - The `useIndicators` hook always fetches all data; client-side filtering with stationIds/dateRange is done via useMemo in the hook
  - The `enabled` pattern from tRPC is replaced by passing undefined stationIds when stations aren't loaded yet
  - The `useClinicalIndicators` hook is passed undefined entirely when no diseases are enabled (vs the tRPC `enabled: false` pattern)
---

## 2026-02-09 - US-203
- Created `src/hooks/use-wastewater-data.ts` with `useStations()`, `useIndicators()`, `useNationalTrend()`
- Created `src/hooks/use-clinical-data.ts` with `useClinicalIndicators()`
- All hooks use `useQuery` from `@tanstack/react-query` directly (not tRPC)
- Client-side filtering with `useMemo` for stationIds, dateRange, and national trend extraction
- `useIndicators` and `useNationalTrend` share the same `['indicators']` queryKey (React Query dedupes)
- `useClinicalIndicators` uses `['clinical-indicators', diseaseIds, department]` as queryKey
- Files changed: `src/hooks/use-wastewater-data.ts` (new), `src/hooks/use-clinical-data.ts` (new)
- **Learnings for future iterations:**
  - React Query v5 deduplicates queries with the same queryKey, so useIndicators and useNationalTrend share the fetch
  - Client-side filtering via useMemo keeps the API simple while avoiding redundant fetches
  - The `enabled` pattern from the PRD AC wasn't needed since the hooks don't depend on each other's data
---

## 2026-02-09 - US-202
- Created `src/services/clinical.ts` with `fetchClinicalIndicators()` and `fetchClinicalIndicatorsByDisease()`
- Uses browser-native fetch with 15s timeout, no `next: { revalidate }`
- Preserves same pagination logic (limit=100, offset loop) and `Promise.allSettled` pattern
- Same type output: `ClinicalIndicator[]`
- Files changed: `src/services/clinical.ts` (new)
- **Learnings for future iterations:**
  - Odissé API supports CORS (`access-control-allow-origin: *`)
  - The clinical service is nearly identical to the server version minus `next: { revalidate }` and import of `REVALIDATE_INTERVAL`
---

## 2026-02-09 - US-201
- Created `src/services/wastewater.ts` with `fetchIndicators()` and `fetchStations()`
- Uses browser-native fetch with 15s timeout, primary endpoints only (no fallback)
- Reuses same CSV parsing logic (Papa Parse, French locale numbers, wide→long unpivot)
- Same type outputs: `WastewaterIndicator[]` and `Station[]`
- Files changed: `src/services/wastewater.ts` (new)
- **Learnings for future iterations:**
  - data.gouv.fr supports CORS, so direct browser fetch works
  - Removing `next: { revalidate }` and fallback pattern significantly simplifies the code
  - The helper functions (stripQuotes, parseFrenchNumber, normalizeWeek, isStationColumn) are duplicated from server version — could be extracted to shared utils if needed later
---
