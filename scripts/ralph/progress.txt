# Ralph Progress Log
Started: Mon 10 Feb 2026

## Codebase Patterns
- Project uses Next.js 15 App Router with TypeScript strict mode (downgraded from 16 due to bundled React canary version mismatch)
- tRPC v11 with superjson transformer — server init in `src/server/trpc/init.ts`, root router in `src/server/trpc/router.ts`
- API route handler at `src/app/api/trpc/[trpc]/route.ts` using fetch adapter
- shadcn/ui with Tailwind CSS v4 — use `npx shadcn@latest add <component>` to add components
- Client-side tRPC provider in `src/components/providers.tsx` wrapping React Query
- Path alias `@/*` maps to `./src/*`
- Shared types in `src/types/wastewater.ts` — import `SeverityLevel`, `TrendDirection`, etc. from `@/types/wastewater`
- Constants (colors, thresholds, URLs) in `src/lib/constants.ts` — import from `@/lib/constants`
- Data fetching service in `src/server/services/sumeau.ts` — use `fetchIndicators()` and `fetchStations()` for server-side data access
- Clinical types in `src/types/clinical.ts` — import `ClinicalDiseaseId`, `ClinicalIndicator`, `ClinicalDatasetMeta` from `@/types/clinical`
- Clinical constants in `src/lib/constants.ts` — `ODISSE_API_BASE`, `CLINICAL_DISEASE_IDS`, `CLINICAL_DATASETS` record with Odissé API config per disease
- Clinical data service in `src/server/services/clinical.ts` — use `fetchClinicalIndicators()` for all diseases, `fetchClinicalIndicatorsByDisease(ids)` for specific ones
- Hooks in `src/hooks/` — `use-local-storage.ts`, `use-station-preferences.ts`, `use-clinical-preferences.ts`, `use-url-sync.ts`
- Health page at `src/app/health/page.tsx` — client component with direct fetch calls for API health checks
- Vitest configured in `vitest.config.ts` with `@/` path alias; test script is `npm run test`
- Drizzle ORM with `@vercel/postgres` adapter — DB client in `src/server/db/index.ts`, schema in `src/server/db/schema.ts`, config in `drizzle.config.ts`
- Drizzle uses `drizzle({ client: sql })` pattern (not `drizzle(sql)`) per latest drizzle-orm v0.45
- DB scripts: `db:generate`, `db:migrate`, `db:push`, `db:studio`
---

## 2026-02-10 - US-040
- Installed `drizzle-orm`, `@vercel/postgres`, `drizzle-kit` (dev)
- Created `src/server/db/index.ts` with Drizzle client using `@vercel/postgres` adapter
- Created `drizzle.config.ts` with postgresql dialect, schema path, and POSTGRES_URL credential
- Added `db:generate`, `db:migrate`, `db:push`, `db:studio` scripts to package.json
- Created placeholder `src/server/db/schema.ts`
- Files changed: `package.json`, `package-lock.json`, `drizzle.config.ts`, `src/server/db/index.ts`, `src/server/db/schema.ts`
- **Learnings for future iterations:**
  - `@vercel/postgres` is deprecated (Vercel migrated to Neon) but still works — PRD specifies it so we use it
  - Latest drizzle-orm v0.45 uses `drizzle({ client: sql })` syntax, not `drizzle(sql)`
  - `drizzle.config.ts` uses `url` (not `connectionString`) in `dbCredentials` for latest drizzle-kit
---

## 2026-02-10 - US-041
- Defined `stationsTable` in `src/server/db/schema.ts` with columns: sandre_id (PK), name, commune, population, lat, lng, updated_at
- Used `pgTable`, `varchar`, `integer`, `doublePrecision`, `timestamp` from `drizzle-orm/pg-core`
- Ran `db:generate` which created migration `drizzle/0000_acoustic_supreme_intelligence.sql`
- Files changed: `src/server/db/schema.ts`, `drizzle/0000_acoustic_supreme_intelligence.sql`, `drizzle/meta/`
- **Learnings for future iterations:**
  - `drizzle-kit generate` does NOT require a live DB connection — it reads the schema and produces SQL
  - Migration files go to `./drizzle/` as configured in `drizzle.config.ts`
  - The generated migration snapshot metadata goes to `drizzle/meta/`
---

