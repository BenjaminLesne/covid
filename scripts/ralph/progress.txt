# Ralph Progress Log
Started: Mon 10 Feb 2026

## Codebase Patterns
- Project uses Next.js 15 App Router with TypeScript strict mode (downgraded from 16 due to bundled React canary version mismatch)
- tRPC v11 with superjson transformer — server init in `src/server/trpc/init.ts`, root router in `src/server/trpc/router.ts`
- API route handler at `src/app/api/trpc/[trpc]/route.ts` using fetch adapter
- shadcn/ui with Tailwind CSS v4 — use `npx shadcn@latest add <component>` to add components
- Client-side tRPC provider in `src/components/providers.tsx` wrapping React Query
- Path alias `@/*` maps to `./src/*`
- Shared types in `src/types/wastewater.ts` — import `SeverityLevel`, `TrendDirection`, etc. from `@/types/wastewater`
- Constants (colors, thresholds, URLs) in `src/lib/constants.ts` — import from `@/lib/constants`
- Data fetching service in `src/server/services/sumeau.ts` — use `fetchIndicators()` and `fetchStations()` for server-side data access
- Clinical types in `src/types/clinical.ts` — import `ClinicalDiseaseId`, `ClinicalIndicator`, `ClinicalDatasetMeta` from `@/types/clinical`
- Clinical constants in `src/lib/constants.ts` — `ODISSE_API_BASE`, `CLINICAL_DISEASE_IDS`, `CLINICAL_DATASETS` record with Odissé API config per disease
- Clinical data service in `src/server/services/clinical.ts` — use `fetchClinicalIndicators()` for all diseases, `fetchClinicalIndicatorsByDisease(ids)` for specific ones
- Hooks in `src/hooks/` — `use-local-storage.ts`, `use-station-preferences.ts`, `use-clinical-preferences.ts`, `use-url-sync.ts`
- Health page at `src/app/health/page.tsx` — client component with direct fetch calls for API health checks
- Vitest configured in `vitest.config.ts` with `@/` path alias; test script is `npm run test`
- Drizzle ORM with `@vercel/postgres` adapter — DB client in `src/server/db/index.ts`, schema in `src/server/db/schema.ts`, config in `drizzle.config.ts`
- Drizzle uses `drizzle({ client: sql })` pattern (not `drizzle(sql)`) per latest drizzle-orm v0.45
- DB scripts: `db:generate`, `db:migrate`, `db:push`, `db:studio`
- Clinical indicators use sentinel value `'national'` for department column (not null) — always filter with `department = 'national'` for national-level data
---

## 2026-02-10 - US-040
- Installed `drizzle-orm`, `@vercel/postgres`, `drizzle-kit` (dev)
- Created `src/server/db/index.ts` with Drizzle client using `@vercel/postgres` adapter
- Created `drizzle.config.ts` with postgresql dialect, schema path, and POSTGRES_URL credential
- Added `db:generate`, `db:migrate`, `db:push`, `db:studio` scripts to package.json
- Created placeholder `src/server/db/schema.ts`
- Files changed: `package.json`, `package-lock.json`, `drizzle.config.ts`, `src/server/db/index.ts`, `src/server/db/schema.ts`
- **Learnings for future iterations:**
  - `@vercel/postgres` is deprecated (Vercel migrated to Neon) but still works — PRD specifies it so we use it
  - Latest drizzle-orm v0.45 uses `drizzle({ client: sql })` syntax, not `drizzle(sql)`
  - `drizzle.config.ts` uses `url` (not `connectionString`) in `dbCredentials` for latest drizzle-kit
---

## 2026-02-10 - US-041
- Defined `stationsTable` in `src/server/db/schema.ts` with columns: sandre_id (PK), name, commune, population, lat, lng, updated_at
- Used `pgTable`, `varchar`, `integer`, `doublePrecision`, `timestamp` from `drizzle-orm/pg-core`
- Ran `db:generate` which created migration `drizzle/0000_acoustic_supreme_intelligence.sql`
- Files changed: `src/server/db/schema.ts`, `drizzle/0000_acoustic_supreme_intelligence.sql`, `drizzle/meta/`
- **Learnings for future iterations:**
  - `drizzle-kit generate` does NOT require a live DB connection — it reads the schema and produces SQL
  - Migration files go to `./drizzle/` as configured in `drizzle.config.ts`
  - The generated migration snapshot metadata goes to `drizzle/meta/`
---

## 2026-02-10 - US-042
- Defined `wastewaterIndicatorsTable` in `src/server/db/schema.ts` with columns: id (serial PK), week (varchar(8)), station_id (varchar), value (doublePrecision, nullable), smoothed_value (doublePrecision, nullable)
- Added unique composite index on `(station_id, week)` via `uniqueIndex`
- Added index on `week` for date range filtering
- Used the third argument of `pgTable` (callback returning array of indexes) for index definitions
- Ran `db:generate` which created migration `drizzle/0001_stormy_praxagora.sql`
- Files changed: `src/server/db/schema.ts`, `drizzle/0001_stormy_praxagora.sql`, `drizzle/meta/`
- **Learnings for future iterations:**
  - Drizzle v0.45 `pgTable` uses a callback `(table) => [...]` as the third argument for indexes/constraints
  - Import `serial`, `uniqueIndex`, `index` from `drizzle-orm/pg-core` for serial PKs and indexes
  - No foreign key to stations table since `station_id = 'National_54'` is not a real station
---

## 2026-02-10 - US-043
- Defined `clinicalIndicatorsTable` in `src/server/db/schema.ts` with columns: id (serial PK), week (varchar(8)), disease_id (varchar), department (varchar, default 'national'), er_visit_rate (doublePrecision, nullable)
- Added unique composite index on `(disease_id, week, department)` to prevent duplicates
- Added index on `week` for date range filtering
- Added index on `disease_id` for disease-specific queries
- Used sentinel value `'national'` for department instead of null to avoid Postgres null-handling in unique indexes
- Also imported `text` from drizzle-orm/pg-core (needed for upcoming sync_metadata table)
- Ran `db:generate` which created migration `drizzle/0002_chunky_lady_vermin.sql`
- Files changed: `src/server/db/schema.ts`, `drizzle/0002_chunky_lady_vermin.sql`, `drizzle/meta/`
- **Learnings for future iterations:**
  - Use sentinel value `'national'` (not null) for department column to simplify unique constraints — this is the pattern for the entire project
  - The `text` import is needed for the `errors` column in sync_metadata (US-044)
  - Consistent index naming pattern: `{table}_{columns}_idx` (e.g., `clinical_disease_week_dept_idx`)
---

## 2026-02-10 - US-044
- Defined `syncMetadataTable` in `src/server/db/schema.ts` with columns: id (serial PK), started_at (timestamp, not null, defaultNow), completed_at (timestamp, nullable), status (varchar, not null), stations_count (integer, default 0), wastewater_count (integer, default 0), clinical_count (integer, default 0), errors (text, nullable)
- Ran `db:generate` which created migration `drizzle/0003_silent_monster_badoon.sql`
- Files changed: `src/server/db/schema.ts`, `drizzle/0003_silent_monster_badoon.sql`, `drizzle/meta/`
- **Learnings for future iterations:**
  - sync_metadata table has no indexes — it's only queried by `ORDER BY started_at DESC LIMIT 1`, which is fine for small tables
  - `status` column stores string values: 'running', 'success', 'partial', 'failed' — no enum type used, just varchar
  - `errors` column is `text` (not jsonb) — stores JSON-serialized array of error strings for simplicity
---

