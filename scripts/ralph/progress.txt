# Ralph Progress Log
Started: Sat  8 Feb 2026

## Codebase Patterns
- Project uses Next.js 15 App Router with TypeScript strict mode (downgraded from 16 due to bundled React canary version mismatch)
- tRPC v11 with superjson transformer — server init in `src/server/trpc/init.ts`, root router in `src/server/trpc/router.ts`
- API route handler at `src/app/api/trpc/[trpc]/route.ts` using fetch adapter
- shadcn/ui with Tailwind CSS v4 — use `npx shadcn@latest add <component>` to add components
- Client-side tRPC provider in `src/components/providers.tsx` wrapping React Query
- Path alias `@/*` maps to `./src/*`
- Shared types in `src/types/wastewater.ts` — import `SeverityLevel`, `TrendDirection`, etc. from `@/types/wastewater`
- Constants (colors, thresholds, URLs) in `src/lib/constants.ts` — import from `@/lib/constants`
- Data fetching service in `src/server/services/sumeau.ts` — use `fetchIndicators()` and `fetchStations()` for server-side data access
- Clinical types in `src/types/clinical.ts` — import `ClinicalDiseaseId`, `ClinicalIndicator`, `ClinicalDatasetMeta` from `@/types/clinical`
- Clinical constants in `src/lib/constants.ts` — `ODISSE_API_BASE`, `CLINICAL_DISEASE_IDS`, `CLINICAL_DATASETS` record with Odissé API config per disease
- Odissé API v2.1 returns flat record fields (not nested in `fields` object like v1); filter `sursaud_cl_age_gene='Tous âges'` for all-age data
- Clinical data service in `src/server/services/clinical.ts` — use `fetchClinicalIndicators()` for all diseases, `fetchClinicalIndicatorsByDisease(ids)` for specific ones
- Odissé API v2.1 records endpoint: `${ODISSE_API_BASE}/${datasetId}/records` with pagination (limit=100, offset-based)
- Clinical tRPC router in `src/server/trpc/routers/clinical.ts` — `getIndicators` procedure with optional diseaseIds + dateRange filters
- `CLINICAL_DISEASE_IDS` readonly array needs `as unknown as [string, ...string[]]` cast for `z.enum()` which requires a non-empty tuple type
- Hooks in `src/hooks/` — `use-local-storage.ts` (generic typed localStorage), `use-station-preferences.ts` (station selection state with max 5 limit)
- Station select combobox in `src/components/filters/station-select.tsx` — uses shadcn/ui Popover + Command (cmdk) pattern
- `useSyncExternalStore` can detect client vs server without useEffect — avoids React lint warning about setState in effects
- shadcn/ui combobox pattern uses Popover + Command (from cmdk library) — not a built-in component
- Clinical preferences hook in `src/hooks/use-clinical-preferences.ts` — `enabledDiseases`, `toggleDisease(id)`, `isEnabled(id)` with localStorage key `eauxvid:clinical-overlays`
- Recharts dual Y-axis: every `Line` `yAxisId` must have a matching `YAxis` rendered, even if the line has `hide=true` — use `hide` prop on the axis itself instead of conditional rendering
- URL state sync in `src/hooks/use-url-sync.ts` — params: from, to, stations, clinical, hidden
- localStorage keys prefixed with `eauxvid:` (e.g. `eauxvid:selected-stations`, `eauxvid:date-range`, `eauxvid:clinical-overlays`)
- Department-level Odissé datasets use suffix `-departement` instead of `-france`, same rate fields, add WHERE `dep='XX'` to filter
- Vitest configured in `vitest.config.ts` with `@/` path alias; test script is `npm run test`
- `stripDiacritics` and `accentInsensitiveFilter` utilities in `src/lib/utils.ts` for accent-insensitive search
---

## 2026-02-08 - US-022
- Implemented `stripDiacritics(str)` and `accentInsensitiveFilter(value, search)` in `src/lib/utils.ts`
- `stripDiacritics` uses `String.normalize('NFD')` + regex to strip combining diacritical marks
- `accentInsensitiveFilter` returns 1/0 for cmdk Command filter prop compatibility
- Files changed: `src/lib/utils.ts`
- **Learnings for future iterations:**
  - The shadcn/ui Command filter prop expects `(value: string, search: string) => number` — return 1 for match, 0 for no match
  - NFD normalization separates base characters from combining marks, making it easy to strip accents with a single regex
---

## 2026-02-08 - US-023
- Applied `accentInsensitiveFilter` to station select combobox via `filter` prop on `<Command>`
- Added "Stations eaux usées" label above the combobox with `text-sm font-medium text-muted-foreground` styling
- Files changed: `src/components/filters/station-select.tsx`
- **Learnings for future iterations:**
  - SUM'Eau station names and commune names are all uppercase ASCII — no accented characters in the dataset
  - The accent-insensitive filter still works correctly as a case-insensitive substring search for unaccented data
  - cmdk `filter` prop on `<Command>` replaces the default fuzzy matching with custom logic — pass `(value, search) => number`
  - The `value` prop on `<CommandItem>` is what gets passed to the filter function — set it to searchable text (e.g., `{station.name} {station.commune}`)
---

