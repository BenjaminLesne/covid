# Ralph Progress Log
Started: Fri 21 Feb 2026

## Codebase Patterns
- Project uses Next.js 15 App Router with TypeScript strict mode
- tRPC v11 with superjson transformer — server init in `src/server/trpc/init.ts`, root router in `src/server/trpc/router.ts`
- API route handler at `src/app/api/trpc/[trpc]/route.ts` using fetch adapter
- shadcn/ui with Tailwind CSS v4 — use `npx shadcn@latest add <component>` to add components
- Client-side tRPC provider in `src/components/providers.tsx` wrapping React Query
- Path alias `@/*` maps to `./src/*`
- Shared types in `src/types/wastewater.ts` and `src/types/clinical.ts`
- Constants (colors, thresholds, URLs) in `src/lib/constants.ts`
- Drizzle ORM v0.45 with `@vercel/postgres` adapter — DB client in `src/server/db/index.ts`, schema in `src/server/db/schema.ts`
- Drizzle uses `drizzle({ client: sql })` pattern (not `drizzle(sql)`) per latest drizzle-orm v0.45
- DB scripts: `db:generate`, `db:migrate`, `db:push`, `db:studio`, `db:seed`
- Clinical indicators use sentinel value `'national'` for department column (not null)
- Sync services in `src/server/services/sync/` — accept `db: VercelPgDatabase` parameter, reuse existing fetch functions
- Sync orchestrator route at `src/app/api/sync/route.ts` — protected by CRON_SECRET
- Drizzle upserts: use `` sql`excluded.column_name` `` (import `sql` from `drizzle-orm`) in `onConflictDoUpdate.set`
- Drizzle dynamic WHERE: build array of conditions, spread into `and(...conditions)`, pass `undefined` for no filter
- Import `and`, `asc`, `eq`, `gte`, `inArray`, `lte` from `drizzle-orm` (not `drizzle-orm/pg-core`)
- DB columns are snake_case — map to camelCase in tRPC responses
- Use `pgTable` third argument callback `(table) => [...]` for indexes/constraints
- `db.insert().values().returning()` returns array — destructure `[row]` for single result
- Recharts already installed — used for wastewater chart in `src/components/wastewater-chart.tsx`
- Home page is 'use client' at `src/app/page.tsx` — uses hooks for state (useDepartmentPreferences, useStationPreferences, etc.)
- Odissé API base: `https://odisse.santepubliquefrance.fr/api/explore/v2.1/`
- Rougeole API uses exports/json endpoint (not records) — returns flat array, no pagination needed
- Rougeole types in `src/types/rougeole.ts`, fetch service in `src/server/services/rougeole.ts`
---

## 2026-02-21 - US-060
- Created `src/types/rougeole.ts` with `RougeoleIndicator` interface
- Created `src/server/services/rougeole.ts` with `fetchRougeoleIndicators()` function
- Fetches from Odissé exports/json endpoint pre-filtered for "Tous âges"
- Files changed: `src/types/rougeole.ts`, `src/server/services/rougeole.ts`
- **Learnings for future iterations:**
  - The rougeole dataset uses exports/json endpoint which returns a flat JSON array (unlike clinical data which uses records endpoint with pagination)
  - Field names: `annee`, `dep`, `libgeo`, `tx`, `rou`, `population`
  - `annee` can be string or number in the API response — always convert to string
---

## 2026-02-21 - US-061
- Added `rougeoleIndicatorsTable` to `src/server/db/schema.ts`
- Columns: id (serial PK), year (varchar), department (varchar, default 'national'), notification_rate (doublePrecision), cases (integer)
- Unique composite index on (year, department)
- Generated migration: `drizzle/0004_chemical_ronan.sql`
- Files changed: `src/server/db/schema.ts`, `drizzle/0004_chemical_ronan.sql`, `drizzle/meta/`
- **Learnings for future iterations:**
  - Follow existing pattern: use `pgTable` third arg callback for indexes
  - `uniqueIndex` imported from `drizzle-orm/pg-core`
---

## 2026-02-21 - US-062
- Created `src/server/services/sync/rougeole-sync.ts` with `syncRougeoleData(db)` function
- Added `rougeole_count` column to `syncMetadataTable` in schema.ts
- Generated migration `drizzle/0005_kind_robbie_robertson.sql`
- Integrated into `/api/sync` route alongside wastewater and clinical
- Computes national aggregates: sum cases, weighted avg rate = (totalCases/totalPop)*100000
- Files changed: `src/server/services/sync/rougeole-sync.ts`, `src/server/db/schema.ts`, `src/app/api/sync/route.ts`, drizzle migrations
- **Learnings for future iterations:**
  - Follow chunk/batch pattern from clinical-sync.ts
  - National aggregate must be computed manually from department data (not in API)
---

## 2026-02-21 - US-063
- Created `src/server/trpc/routers/rougeole.ts` with `getIndicators` query
- Registered `rougeoleRouter` in root router at `src/server/trpc/router.ts`
- Query accepts optional `department` input, defaults to 'national'
- Maps snake_case DB columns to camelCase response
- Files changed: `src/server/trpc/routers/rougeole.ts`, `src/server/trpc/router.ts`
---

## 2026-02-21 - US-064
- Created `src/components/rougeole-chart.tsx` with Recharts LineChart
- Single line for notification rate, red/coral color (hsl(0, 70%, 50%))
- X-axis: years, Y-axis: rate /100 000 hab., dots on data points, tooltip with 2 decimal formatting
- Loading skeleton, error state, wrapped in Card component
- Added to home page below chart+map grid section
- Files changed: `src/components/rougeole-chart.tsx`, `src/app/page.tsx`
- **Learnings for future iterations:**
  - RougeoleChart accepts `department` prop from home page — this also covers US-065 department filtering
  - Uses `useMemo` for departmentLabel lookup from FRENCH_DEPARTMENTS constants
---

## 2026-02-21 - US-065
- Already fully implemented as part of US-064 — no additional code changes needed
- Verified: department prop wired from `useDepartmentPreferences()` → RougeoleChart → tRPC query
- tRPC router defaults to 'national' when no department specified
- Chart subtitle shows "France entière" or "code — name" for selected department
- Browser verification: UI renders correctly (DB error expected — infra not set up yet)
- Files changed: `tasks/prd.json` (marked US-064 and US-065 as passing)
- **Learnings for future iterations:**
  - When building a chart component, wire department filtering from the start to avoid a separate story
  - The `Cannot read properties of undefined (reading 'call')` error in Next.js dev is a webpack HMR issue — fixed by hard reload
---

## 2026-02-21 - US-066
- Created `src/app/info/page.tsx` — server component at `/info` route
- Three sections with Card components: Eaux usées (SUM'Eau), Passages aux urgences (SurSaUD/Odissé), Rougeole (DO)
- Each section explains the data source, metrics, frequency, and links to the original data
- Includes back-link to home page, page metadata for SEO
- All text in French, external links with target="_blank" rel="noopener noreferrer"
- Browser verified: page renders correctly with dark theme
- Files changed: `src/app/info/page.tsx`, `tasks/prd.json`
- **Learnings for future iterations:**
  - Info pages are simple server components — no 'use client' needed, no tRPC
  - shadcn Card components work well for structured content sections
  - Use `&apos;` for apostrophes in JSX to avoid HTML entity issues
---

## 2026-02-21 - US-067
- Added "À propos des données" link in header (`src/components/layout/header.tsx`) between title and controls
- Added "En savoir plus sur les données →" inline link in home page disclaimer text (`src/app/page.tsx`)
- Both links use Next.js `Link` component for client-side navigation to `/info`
- Header link hidden on mobile (`hidden sm:block`) to avoid crowding
- Browser verified: both links render and navigate correctly
- Files changed: `src/components/layout/header.tsx`, `src/app/page.tsx`, `tasks/prd.json`
- **Learnings for future iterations:**
  - Header uses flex with gap — adjust `gap-1` to `gap-3` when adding text links alongside icon buttons
  - Inline links in paragraphs work well for contextual navigation (inside disclaimer text)
---

