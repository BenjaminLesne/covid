# Ralph Progress Log
Started: Sam  7 fév 2026 18:37:38 CET

## Codebase Patterns
- Project uses Next.js 16 App Router with TypeScript strict mode
- tRPC v11 with superjson transformer — server init in `src/server/trpc/init.ts`, root router in `src/server/trpc/router.ts`
- API route handler at `src/app/api/trpc/[trpc]/route.ts` using fetch adapter
- shadcn/ui with Tailwind CSS v4 — use `npx shadcn@latest add <component>` to add components
- Client-side tRPC provider in `src/components/providers.tsx` wrapping React Query
- Path alias `@/*` maps to `./src/*`
- Shared types in `src/types/wastewater.ts` — import `SeverityLevel`, `TrendDirection`, etc. from `@/types/wastewater`
- Constants (colors, thresholds, URLs) in `src/lib/constants.ts` — import from `@/lib/constants`
- Data fetching service in `src/server/services/sumeau.ts` — use `fetchIndicators()` and `fetchStations()` for server-side data access
- CSV uses wide format (station names as columns), semicolon delimiter, French decimal separator (comma)
- Indicators CSV week column `semaine` uses `YYYY-SWW` format — normalized to `YYYY-WWW` (ISO week)
- `NA` in CSV = null value; JSON fallback has proper nulls (missing fields)
- JSON fallback station names are snake_cased; CSV station names are original display names
- Vitest configured in `vitest.config.ts` with `@/` path alias; test script is `npm run test`
- Severity functions in `src/lib/severity.ts` — import `calculateSeverityLevel`, `calculateTrend`, `getSeverityColor`
---

## 2026-02-07 - US-001
- Scaffolded Next.js 16 project with App Router, TypeScript strict, Tailwind CSS v4
- Set up tRPC v11 with root router, wastewater sub-router (ping placeholder), and fetch adapter API route
- Initialized shadcn/ui with default theme
- Created tRPC + React Query provider component
- Updated root layout with French lang, EauxVid metadata
- Files created: package.json, tsconfig.json, src/app/layout.tsx, src/app/page.tsx, src/server/trpc/init.ts, src/server/trpc/router.ts, src/server/trpc/routers/wastewater.ts, src/app/api/trpc/[trpc]/route.ts, src/components/providers.tsx, src/lib/trpc.ts, src/lib/utils.ts, components.json, globals.css
- **Learnings for future iterations:**
  - create-next-app v16 prompts for React Compiler (answer N to skip)
  - create-next-app won't run in a directory with existing files — scaffold in temp dir then rsync
  - shadcn/ui `init -d` picks sensible defaults (New York style, neutral colors)
  - Tailwind CSS v4 uses `@import "tailwindcss"` instead of v3 `@tailwind` directives
---

## 2026-02-07 - US-002
- Created `src/types/wastewater.ts` with typed interfaces: WastewaterIndicator, Station, NationalAggregate, SeverityLevel, TrendDirection, SeverityClassification
- Created `src/lib/constants.ts` with: SEVERITY_LEVELS (colors + labels), PERCENTILE_THRESHOLDS, TREND_THRESHOLD, REVALIDATE_INTERVAL, MAX_SELECTED_STATIONS, NATIONAL_STATION_ID, DATA_URLS, DEFAULT_DATE_RANGE_MONTHS
- Files created: src/types/wastewater.ts, src/lib/constants.ts
- **Learnings for future iterations:**
  - Types use `number | null` for indicator values since some weeks may have missing data
  - `SeverityLevel` is a union type `1 | 2 | 3 | 4 | 5` (not a plain number) for type safety
  - `SEVERITY_LEVELS` uses `as const satisfies Record<...>` pattern for strict typing with autocomplete
  - Station IDs use the SANDRE identifier system; national aggregate uses the special ID "national"
---

## 2026-02-07 - US-003
- Created `src/server/services/sumeau.ts` with `fetchIndicators()` and `fetchStations()` functions
- Installed papaparse + @types/papaparse for CSV parsing
- Primary: data.gouv.fr CSV endpoints (semicolon-delimited, wide format for indicators)
- Fallback: Odissé JSON endpoints (snake_cased station names, proper floats)
- Handles French number locale (comma → dot), NA → null, week format normalization (YYYY-SWW → YYYY-WWW)
- Both functions use Next.js fetch with `revalidate: 21600` (6 hours)
- Files created: src/server/services/sumeau.ts
- Files modified: package.json, package-lock.json
- **Learnings for future iterations:**
  - Indicators CSV is wide format — each station is a column, rows are weeks. Need to pivot to long format for WastewaterIndicator[]
  - CSV uses semicolons as delimiters (French CSV convention), not commas
  - French number format uses comma as decimal separator — must replace with dot before parsing
  - `National_12` (original 12 stations) and `National_54` (all 54 stations) are national aggregate columns
  - Odissé JSON has `date_complet` field (Monday of the week) not present in CSV — useful if ISO date needed
  - JSON fallback wraps data in `{ datasetid, recordid, fields: {...}, record_timestamp }` envelope
  - Station names in CSV indicators are display names (e.g. "PARIS SEINE-CENTRE"), in JSON they're snake_cased (e.g. "paris_seine_centre")
- tRPC procedures go in `src/server/trpc/routers/wastewater.ts` — use zod v4 for input validation
- National aggregate column in indicators data is `National_54` (all 54 stations)
- Week strings are ISO-week format (e.g. "2024-W03") — string comparison works for date range filtering
---

## 2026-02-07 - US-004
- Created tRPC wastewater router with three procedures: getIndicators, getStations, getNationalTrend
- getIndicators: accepts optional stationIds string[] and dateRange {from, to}, filters indicators from fetchIndicators()
- getStations: returns all stations from fetchStations()
- getNationalTrend: extracts National_54 column from indicators, returns sorted NationalAggregate[]
- Used zod v4 for input validation schemas
- Router was already merged into root router from US-001 scaffold
- Files modified: src/server/trpc/routers/wastewater.ts
- **Learnings for future iterations:**
  - The wastewater router was already scaffolded with a placeholder `ping` procedure in US-001 — just needed to replace it
  - Root router (`src/server/trpc/router.ts`) already imports and merges the wastewater router — no changes needed there
  - National aggregate uses column name `National_54` in the indicators data (not the `NATIONAL_STATION_ID` constant "national")
  - ISO week strings (YYYY-WWW) sort lexicographically, so string comparison works for date range filtering
  - zod v4 API is compatible with zod v3 for basic schemas (z.object, z.string, z.array, z.optional)
---

## 2026-02-07 - US-005
- Created `src/lib/severity.ts` with three functions:
  - `calculateSeverityLevel(currentValue, historicalValues)` — quintile-based classification returning SeverityLevel 1–5
  - `calculateTrend(currentValue, twoWeeksAgoValue)` — ±10% threshold comparison returning TrendDirection
  - `getSeverityColor(level)` — maps SeverityLevel to hex color from SEVERITY_LEVELS constant
- Set up Vitest test framework: installed vitest, created `vitest.config.ts` with `@/` path alias, added `npm run test` script
- Created `src/lib/severity.test.ts` with 25 unit tests covering all functions and edge cases
- Files created: src/lib/severity.ts, src/lib/severity.test.ts, vitest.config.ts
- Files modified: package.json, package-lock.json
- **Learnings for future iterations:**
  - Vitest v4 works out of the box with TypeScript — no extra config needed beyond path aliases
  - Percentile calculation uses linear interpolation between sorted values for non-integer indices
  - For severity: null currentValue → level 3 (Moderate), empty historical → level 3 (safe default)
  - For trend: null values → "stable" (safe default), zero baseline handled specially to avoid division by zero
  - Trend uses `Math.abs(twoWeeksAgoValue)` as denominator to handle negative values correctly
---
