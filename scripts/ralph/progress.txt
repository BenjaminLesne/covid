# Ralph Progress Log
Started: Sam  7 fév 2026 18:37:38 CET

## Codebase Patterns
- Project uses Next.js 15 App Router with TypeScript strict mode (downgraded from 16 due to bundled React canary version mismatch)
- tRPC v11 with superjson transformer — server init in `src/server/trpc/init.ts`, root router in `src/server/trpc/router.ts`
- API route handler at `src/app/api/trpc/[trpc]/route.ts` using fetch adapter
- shadcn/ui with Tailwind CSS v4 — use `npx shadcn@latest add <component>` to add components
- Client-side tRPC provider in `src/components/providers.tsx` wrapping React Query
- Path alias `@/*` maps to `./src/*`
- Shared types in `src/types/wastewater.ts` — import `SeverityLevel`, `TrendDirection`, etc. from `@/types/wastewater`
- Constants (colors, thresholds, URLs) in `src/lib/constants.ts` — import from `@/lib/constants`
- Data fetching service in `src/server/services/sumeau.ts` — use `fetchIndicators()` and `fetchStations()` for server-side data access
- CSV uses wide format (station names as columns), semicolon delimiter, French decimal separator (comma)
- Indicators CSV week column `semaine` uses `YYYY-SWW` format — normalized to `YYYY-WWW` (ISO week)
- `NA` in CSV = null value; JSON fallback has proper nulls (missing fields)
- JSON fallback station names are snake_cased; CSV station names are original display names
- Vitest configured in `vitest.config.ts` with `@/` path alias; test script is `npm run test`
- Severity functions in `src/lib/severity.ts` — import `calculateSeverityLevel`, `calculateTrend`, `getSeverityColor`
- Dark/light mode: `next-themes` ThemeProvider wraps app in `src/components/providers.tsx`; toggle in `src/components/layout/theme-toggle.tsx`
- Layout components in `src/components/layout/` — header.tsx, footer.tsx, theme-toggle.tsx
- Root layout uses `suppressHydrationWarning` on `<html>` for next-themes compatibility
- shadcn/ui button component at `src/components/ui/button.tsx`
- shadcn/ui card, badge, skeleton components in `src/components/ui/`
- Severity components in `src/components/severity/` — severity-badge.tsx, severity-summary.tsx
- SeveritySummary fetches national trend via tRPC, computes severity level + trend, displays in Card
- Hooks in `src/hooks/` — `use-local-storage.ts` (generic typed localStorage), `use-station-preferences.ts` (station selection state with max 5 limit)
- Station select combobox in `src/components/filters/station-select.tsx` — uses shadcn/ui Popover + Command (cmdk) pattern
- shadcn/ui popover, command, dialog components in `src/components/ui/`
- Station IDs use SANDRE identifiers from `Station.sandreId`; national uses `NATIONAL_STATION_ID` constant ("national")
- localStorage keys prefixed with `eauxvid:` (e.g. `eauxvid:selected-stations`, `eauxvid:date-range`)
- Date range hook in `src/hooks/use-date-range.ts` — provides `fromDate`, `toDate`, `setRange`, `reset`
- Date range picker in `src/components/filters/date-range-picker.tsx` — Popover + Calendar (react-day-picker range mode)
- shadcn/ui calendar component in `src/components/ui/calendar.tsx` — wraps react-day-picker
- `useLocalStorage` uses `useSyncExternalStore` for SSR-safe client detection (no setState in useEffect)
---

## 2026-02-07 - US-001
- Scaffolded Next.js 16 project with App Router, TypeScript strict, Tailwind CSS v4
- Set up tRPC v11 with root router, wastewater sub-router (ping placeholder), and fetch adapter API route
- Initialized shadcn/ui with default theme
- Created tRPC + React Query provider component
- Updated root layout with French lang, EauxVid metadata
- Files created: package.json, tsconfig.json, src/app/layout.tsx, src/app/page.tsx, src/server/trpc/init.ts, src/server/trpc/router.ts, src/server/trpc/routers/wastewater.ts, src/app/api/trpc/[trpc]/route.ts, src/components/providers.tsx, src/lib/trpc.ts, src/lib/utils.ts, components.json, globals.css
- **Learnings for future iterations:**
  - create-next-app v16 prompts for React Compiler (answer N to skip)
  - create-next-app won't run in a directory with existing files — scaffold in temp dir then rsync
  - shadcn/ui `init -d` picks sensible defaults (New York style, neutral colors)
  - Tailwind CSS v4 uses `@import "tailwindcss"` instead of v3 `@tailwind` directives
---

## 2026-02-07 - US-002
- Created `src/types/wastewater.ts` with typed interfaces: WastewaterIndicator, Station, NationalAggregate, SeverityLevel, TrendDirection, SeverityClassification
- Created `src/lib/constants.ts` with: SEVERITY_LEVELS (colors + labels), PERCENTILE_THRESHOLDS, TREND_THRESHOLD, REVALIDATE_INTERVAL, MAX_SELECTED_STATIONS, NATIONAL_STATION_ID, DATA_URLS, DEFAULT_DATE_RANGE_MONTHS
- Files created: src/types/wastewater.ts, src/lib/constants.ts
- **Learnings for future iterations:**
  - Types use `number | null` for indicator values since some weeks may have missing data
  - `SeverityLevel` is a union type `1 | 2 | 3 | 4 | 5` (not a plain number) for type safety
  - `SEVERITY_LEVELS` uses `as const satisfies Record<...>` pattern for strict typing with autocomplete
  - Station IDs use the SANDRE identifier system; national aggregate uses the special ID "national"
---

## 2026-02-07 - US-003
- Created `src/server/services/sumeau.ts` with `fetchIndicators()` and `fetchStations()` functions
- Installed papaparse + @types/papaparse for CSV parsing
- Primary: data.gouv.fr CSV endpoints (semicolon-delimited, wide format for indicators)
- Fallback: Odissé JSON endpoints (snake_cased station names, proper floats)
- Handles French number locale (comma → dot), NA → null, week format normalization (YYYY-SWW → YYYY-WWW)
- Both functions use Next.js fetch with `revalidate: 21600` (6 hours)
- Files created: src/server/services/sumeau.ts
- Files modified: package.json, package-lock.json
- **Learnings for future iterations:**
  - Indicators CSV is wide format — each station is a column, rows are weeks. Need to pivot to long format for WastewaterIndicator[]
  - CSV uses semicolons as delimiters (French CSV convention), not commas
  - French number format uses comma as decimal separator — must replace with dot before parsing
  - `National_12` (original 12 stations) and `National_54` (all 54 stations) are national aggregate columns
  - Odissé JSON has `date_complet` field (Monday of the week) not present in CSV — useful if ISO date needed
  - JSON fallback wraps data in `{ datasetid, recordid, fields: {...}, record_timestamp }` envelope
  - Station names in CSV indicators are display names (e.g. "PARIS SEINE-CENTRE"), in JSON they're snake_cased (e.g. "paris_seine_centre")
- tRPC procedures go in `src/server/trpc/routers/wastewater.ts` — use zod v4 for input validation
- National aggregate column in indicators data is `National_54` (all 54 stations)
- Week strings are ISO-week format (e.g. "2024-W03") — string comparison works for date range filtering
---

## 2026-02-07 - US-004
- Created tRPC wastewater router with three procedures: getIndicators, getStations, getNationalTrend
- getIndicators: accepts optional stationIds string[] and dateRange {from, to}, filters indicators from fetchIndicators()
- getStations: returns all stations from fetchStations()
- getNationalTrend: extracts National_54 column from indicators, returns sorted NationalAggregate[]
- Used zod v4 for input validation schemas
- Router was already merged into root router from US-001 scaffold
- Files modified: src/server/trpc/routers/wastewater.ts
- **Learnings for future iterations:**
  - The wastewater router was already scaffolded with a placeholder `ping` procedure in US-001 — just needed to replace it
  - Root router (`src/server/trpc/router.ts`) already imports and merges the wastewater router — no changes needed there
  - National aggregate uses column name `National_54` in the indicators data (not the `NATIONAL_STATION_ID` constant "national")
  - ISO week strings (YYYY-WWW) sort lexicographically, so string comparison works for date range filtering
  - zod v4 API is compatible with zod v3 for basic schemas (z.object, z.string, z.array, z.optional)
---

## 2026-02-07 - US-005
- Created `src/lib/severity.ts` with three functions:
  - `calculateSeverityLevel(currentValue, historicalValues)` — quintile-based classification returning SeverityLevel 1–5
  - `calculateTrend(currentValue, twoWeeksAgoValue)` — ±10% threshold comparison returning TrendDirection
  - `getSeverityColor(level)` — maps SeverityLevel to hex color from SEVERITY_LEVELS constant
- Set up Vitest test framework: installed vitest, created `vitest.config.ts` with `@/` path alias, added `npm run test` script
- Created `src/lib/severity.test.ts` with 25 unit tests covering all functions and edge cases
- Files created: src/lib/severity.ts, src/lib/severity.test.ts, vitest.config.ts
- Files modified: package.json, package-lock.json
- **Learnings for future iterations:**
  - Vitest v4 works out of the box with TypeScript — no extra config needed beyond path aliases
  - Percentile calculation uses linear interpolation between sorted values for non-integer indices
  - For severity: null currentValue → level 3 (Moderate), empty historical → level 3 (safe default)
  - For trend: null values → "stable" (safe default), zero baseline handled specially to avoid division by zero
  - Trend uses `Math.abs(twoWeeksAgoValue)` as denominator to handle negative values correctly
---

## 2026-02-07 - US-006
- Created `src/components/layout/header.tsx` with app name "EauxVid", Droplets icon, subtitle (hidden on mobile)
- Created `src/components/layout/footer.tsx` with data source attribution links to SUM'Eau and Santé publique France
- Created `src/components/layout/theme-toggle.tsx` with Sun/Moon icon toggle using next-themes
- Created `src/components/theme-provider.tsx` wrapping next-themes ThemeProvider (attribute="class", defaultTheme="system")
- Updated `src/app/layout.tsx` with responsive container (max-w-7xl), flex column layout, header/main/footer structure
- Updated `src/components/providers.tsx` to include ThemeProvider wrapping tRPC/React Query providers
- Added shadcn button component and next-themes dependency
- Files created: src/components/layout/header.tsx, src/components/layout/footer.tsx, src/components/layout/theme-toggle.tsx, src/components/theme-provider.tsx, src/components/ui/button.tsx
- Files modified: src/app/layout.tsx, src/app/page.tsx, src/components/providers.tsx, package.json, package-lock.json
- **Learnings for future iterations:**
  - next-themes requires `suppressHydrationWarning` on `<html>` element to avoid React hydration mismatch warnings
  - next-themes `attribute="class"` works with shadcn/ui's `.dark` class-based theming out of the box
  - Theme toggle uses `resolvedTheme` (not `theme`) to get the actual applied theme when system preference is active
  - Header subtitle hidden on mobile with `hidden sm:block` — keeps header compact on small screens
  - Layout uses `flex min-h-screen flex-col` on a wrapper div so footer is pushed to the bottom
---

## 2026-02-07 - US-007
- Created `src/components/severity/severity-badge.tsx` — color-coded circle + severity label (Very Low/Low/Moderate/High/Very High)
- Created `src/components/severity/severity-summary.tsx` — national level card with large badge, trend arrow (↑↓→), last updated date
- SeveritySummary fetches national trend data via tRPC `getNationalTrend`, computes severity using `calculateSeverityLevel` and trend using `calculateTrend`
- Added shadcn/ui card, badge, skeleton components
- Updated `src/app/page.tsx` to include SeveritySummary as first dashboard component
- Downgraded Next.js from 16.1.6 to 15.5.12 to fix React canary version mismatch (react 19.3.0-canary vs react-dom 19.2.0-canary bundled internally)
- Verified in browser: card displays "Low" severity (green), "En baisse" trend, "Semaine 2, 2026" date
- Files created: src/components/severity/severity-badge.tsx, src/components/severity/severity-summary.tsx, src/components/ui/card.tsx, src/components/ui/badge.tsx, src/components/ui/skeleton.tsx
- Files modified: src/app/page.tsx, package.json, package-lock.json, tasks/prd.json
- **Learnings for future iterations:**
  - Next.js 16 has a React canary version mismatch bug — bundled react (19.3.0-canary) and react-dom (19.2.0-canary) don't match, preventing client-side hydration entirely. Downgrade to Next.js 15 to fix.
  - Loading states are important for tRPC queries — use shadcn Skeleton components for loading UI
  - National trend data is sorted chronologically by week — latest entry is `array[length-1]`, two weeks ago is `array[length-3]`
  - French UI labels: "En hausse" (increasing), "Stable" (stable), "En baisse" (decreasing), "Niveau national" (national level)
  - Week format `YYYY-WNN` can be parsed with regex to display "Semaine N, YYYY" in French
---

## 2026-02-07 - US-008
- Created `src/hooks/use-local-storage.ts` — generic typed hook for localStorage read/write with SSR safety and hydration handling
- Created `src/hooks/use-station-preferences.ts` — manages selected station IDs with national always included, max 5 limit, add/remove/toggle
- Added shadcn/ui popover, command, and dialog components
- Created `src/components/filters/station-select.tsx` — searchable multi-select combobox using Popover + Command (cmdk) pattern
- Combobox searches by station name and commune name, shows checkmarks for selected items
- National average shown as permanent disabled option with "toujours actif" label
- Selected stations shown as removable Badge chips below the combobox
- Updated `src/app/page.tsx` to include StationSelect
- Verified in browser: search, select, remove, localStorage persistence across reload all working
- Files created: src/hooks/use-local-storage.ts, src/hooks/use-station-preferences.ts, src/components/filters/station-select.tsx, src/components/ui/popover.tsx, src/components/ui/command.tsx, src/components/ui/dialog.tsx
- Files modified: src/app/page.tsx, package.json, package-lock.json
- **Learnings for future iterations:**
  - shadcn/ui combobox pattern uses Popover + Command (from cmdk library) — not a built-in component
  - `npx shadcn@latest add popover command` installs dialog as a dependency of command
  - cmdk CommandInput has built-in search filtering that matches against CommandItem `value` prop — set value to `"name commune"` for multi-field search
  - useLocalStorage hook needs hydration awareness — return defaultValue until `useEffect` runs to avoid SSR/client mismatch
  - Station SANDRE IDs are the canonical identifiers; station `name` is the display name (e.g. "PARIS MARNE AVAL")
  - French UI: "Ajouter une station" (add), "sélectionnée(s)" (selected), "Rechercher par nom ou commune" (search), "Aucune station trouvée" (no results)
  - Popover width matches trigger with `w-[var(--radix-popover-trigger-width)]`
- `useSyncExternalStore` can detect client vs server without useEffect — avoids React lint warning about setState in effects
- shadcn/ui calendar uses `react-day-picker` — supports `mode="range"` for date range selection with `numberOfMonths={2}` for dual-month view
- Date range hook in `src/hooks/use-date-range.ts` — uses `useLocalStorage` with `eauxvid:date-range` key
- Date range picker in `src/components/filters/date-range-picker.tsx` — uses Popover + Calendar (react-day-picker range mode)
---

## 2026-02-07 - US-009
- Created `src/hooks/use-date-range.ts` — manages date range with localStorage persistence via `useLocalStorage` hook
- Created `src/components/filters/date-range-picker.tsx` — dual-month calendar popover with range selection using shadcn/ui Calendar + Popover
- Added shadcn/ui calendar component (installs `react-day-picker` dependency)
- Default range is last 6 months from today (uses `DEFAULT_DATE_RANGE_MONTHS` from constants)
- Calendar uses `captionLayout="dropdown"` for month/year navigation, `disabled={{ after: new Date() }}` to prevent future dates
- Reset button (RotateCcw icon) resets to default 6-month range
- French date formatting via `toLocaleDateString("fr-FR")` — displays "7 août 2025 — 7 févr. 2026" style
- Updated `src/app/page.tsx` to include DateRangePicker alongside StationSelect in a responsive flex layout
- Fixed pre-existing lint error in `use-local-storage.ts`: replaced `useState+useEffect` hydration pattern with `useSyncExternalStore` to avoid React lint warning about setState in effects
- Verified in browser: calendar opens, range selection works, dates display correctly in French, no console errors
- Files created: src/hooks/use-date-range.ts, src/components/filters/date-range-picker.tsx, src/components/ui/calendar.tsx
- Files modified: src/app/page.tsx, src/hooks/use-local-storage.ts, package.json, package-lock.json
- **Learnings for future iterations:**
  - shadcn/ui Calendar component wraps `react-day-picker` — use `mode="range"` with `onSelect` receiving `DateRange | undefined`
  - `react-day-picker` DateRange type: `{ from?: Date; to?: Date }` — both optional during selection
  - `captionLayout="dropdown"` enables month/year dropdown navigation; `startMonth`/`endMonth` control dropdown range
  - `useSyncExternalStore(subscribe, getSnapshot, getServerSnapshot)` is the React-approved way to detect client vs server — returns server snapshot during SSR, client snapshot after hydration
  - The subscribe function for static values (like isClient) can be a no-op that returns a cleanup function
  - `numberOfMonths={2}` shows two months side by side; responsive on desktop, may need adjustment on mobile
  - Date stored as ISO string (YYYY-MM-DD) in localStorage for JSON serialization; parsed to Date objects in the hook
---
