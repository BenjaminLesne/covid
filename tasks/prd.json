{
  "project": "EauxVid",
  "branchName": "ralph/clinical-geo-filter",
  "description": "Add department-level geographic selector for clinical/hospitalization data, and accent-insensitive search for all comboboxes",
  "userStories": [
    {
      "id": "US-022",
      "title": "Add accent-insensitive search utility",
      "description": "As a French user, I want the search to match accented characters regardless of whether I type accents, so that searching 'Herault' finds 'Hérault'.",
      "acceptanceCriteria": [
        "Create a `stripDiacritics(str: string): string` utility in `src/lib/utils.ts` that uses `String.prototype.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '')` to strip accents",
        "Create a `accentInsensitiveFilter(value: string, search: string): number` function in `src/lib/utils.ts` that returns 1 if the stripped-lowercase search is a substring of stripped-lowercase value, 0 otherwise",
        "Both functions are exported from `src/lib/utils.ts`",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "These utilities will be consumed by the station-select and the new department-select comboboxes."
    },
    {
      "id": "US-023",
      "title": "Apply accent-insensitive filter to station select combobox",
      "description": "As a user, I want the wastewater station search to match accented characters loosely, so that typing 'Beziers' finds 'BÉZIERS' and typing 'Herault' finds stations in Hérault.",
      "acceptanceCriteria": [
        "Import `accentInsensitiveFilter` from `@/lib/utils` in `src/components/filters/station-select.tsx`",
        "Pass the `filter` prop to the `<Command>` component: `filter={accentInsensitiveFilter}`",
        "Searching 'beziers' or 'Beziers' matches stations whose name or commune contains 'Béziers' (or similar accented variants)",
        "Searching 'herault' matches communes containing 'Hérault'",
        "Existing search behavior (case-insensitive substring) is preserved for non-accented queries",
        "Add a label above the station select: a `<label>` or heading text reading 'Stations eaux usées' styled as `text-sm font-medium text-muted-foreground` so it is visually distinct from the clinical geographic selector added later",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 2,
      "passes": true,
      "notes": "The shadcn/ui Command component accepts a `filter` prop: `(value: string, search: string) => number`. Return 1 for match, 0 for no match."
    },
    {
      "id": "US-024",
      "title": "Add department dataset IDs to clinical constants",
      "description": "As a developer, I need department-level Odissé dataset IDs configured alongside the existing national ones, so that the clinical service can dynamically choose which dataset to query.",
      "acceptanceCriteria": [
        "Add a `departmentDatasetId` field to `ClinicalDatasetMeta` in `src/types/clinical.ts` — type `string`",
        "In `src/lib/constants.ts`, populate `departmentDatasetId` for each disease in `CLINICAL_DATASETS`: flu → `grippe-passages-aux-urgences-et-actes-sos-medecins-departement`, bronchiolitis → `bronchiolite-passages-aux-urgences-et-actes-sos-medecins-departement`, covid_clinical → `covid-19-passages-aux-urgences-et-actes-sos-medecins-departement`",
        "Add a `FRENCH_DEPARTMENTS` constant in `src/lib/constants.ts` — a readonly array of `{ code: string; name: string }` objects for all 101 metropolitan + 5 overseas departments (from '01 Ain' through '976 Mayotte'). Use the official French department codes as strings (e.g., '2A' for Corse-du-Sud, '2B' for Haute-Corse, '971' through '976' for overseas)",
        "Export `FRENCH_DEPARTMENTS` from constants",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "The department list is static and small (~106 entries). Hardcoding is simpler and faster than an API call. The department-level datasets use the same rate field names and age filters as national ones — only the dataset ID differs, plus the `dep` field in the WHERE clause."
    },
    {
      "id": "US-025",
      "title": "Update clinical service to support department-level queries",
      "description": "As a developer, I need the clinical data fetching service to optionally query department-level datasets with a department code filter, so that the tRPC router can serve department-scoped data.",
      "acceptanceCriteria": [
        "Modify `fetchSingleDisease` in `src/server/services/clinical.ts` to accept an optional `department?: string` parameter",
        "When `department` is provided: use `meta.departmentDatasetId` instead of `meta.datasetId`, and append `AND dep='${department}'` to the existing WHERE clause (properly escaped in the URL)",
        "When `department` is not provided: behavior is unchanged (national dataset, no dep filter)",
        "Update `fetchClinicalIndicatorsByDisease` signature to accept optional `department?: string` and pass it through to `fetchSingleDisease`",
        "Update `fetchClinicalIndicators` signature to accept optional `department?: string` and pass it through",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "The Odissé API v2.1 WHERE clause for department queries should be: `sursaud_cl_age_gene='Tous âges' AND dep='44'` (or the relevant age filter for bronchiolitis). The `dep` field is a string like '44', '2A', '971', etc."
    },
    {
      "id": "US-026",
      "title": "Update clinical tRPC router to accept department parameter",
      "description": "As a developer, I need the clinical tRPC procedure to accept an optional department code, so that the frontend can request department-scoped clinical data.",
      "acceptanceCriteria": [
        "Add optional `department: z.string().optional()` to the `getIndicators` input schema in `src/server/trpc/routers/clinical.ts`",
        "Pass `input.department` to `fetchClinicalIndicatorsByDisease` or `fetchClinicalIndicators`",
        "When `department` is undefined, behavior is unchanged (national data returned)",
        "When `department` is e.g. '44', department-level data is returned",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-027",
      "title": "Create department preferences hook",
      "description": "As a developer, I need a hook to manage the selected department for clinical data, persisted in localStorage.",
      "acceptanceCriteria": [
        "Create `src/hooks/use-department-preferences.ts` with a `useDepartmentPreferences` hook",
        "Hook returns `{ department: string | null, setDepartment: (code: string | null) => void, departmentLabel: string }` where `null` means 'France entière' (national)",
        "Uses `useLocalStorage` with key `eauxvid:clinical-department`, default `null`",
        "`departmentLabel` returns 'France entière' when department is null, or the department name from `FRENCH_DEPARTMENTS` when a code is selected (e.g., '44' → 'Loire-Atlantique')",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-028",
      "title": "Create department select combobox component",
      "description": "As a user, I want a dropdown to select a geographic area for clinical/hospitalization data, defaulting to national, so that I can drill down to my department.",
      "acceptanceCriteria": [
        "Create `src/components/filters/department-select.tsx` using the shadcn Popover + Command combobox pattern (same as station-select)",
        "Label above the selector reads 'Zone géographique — Urgences' styled as `text-sm font-medium text-muted-foreground`",
        "Default display text in the button: 'France entière'",
        "When a department is selected, the button shows e.g. '44 — Loire-Atlantique'",
        "The combobox lists all departments from `FRENCH_DEPARTMENTS`, searchable by code and name",
        "A first entry 'France entière' is always shown at the top and represents the national level (sets department to null)",
        "Uses `accentInsensitiveFilter` from `@/lib/utils` for accent-insensitive search",
        "Uses `useDepartmentPreferences` hook for state management",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 7,
      "passes": true,
      "notes": "The combobox should show a check icon next to the selected item. Selecting 'France entière' clears the department selection. Use the Hospital icon from lucide-react to visually distinguish from the wastewater station select which uses MapPin."
    },
    {
      "id": "US-029",
      "title": "Integrate department selector into dashboard and pass to chart",
      "description": "As a user, I want the department selection to filter the clinical overlay data on the chart, with the legend reflecting the selected geographic scope.",
      "acceptanceCriteria": [
        "Add `DepartmentSelect` to `src/app/page.tsx` in the filters section, alongside (but visually separate from) the station select",
        "The layout should clearly group: wastewater station select on one side, department select on the other — they should not look like they control the same data",
        "Pass `department` from `useDepartmentPreferences` to the `trpc.clinical.getIndicators` query in `src/components/chart/wastewater-chart.tsx`",
        "When a department is selected, clinical legend labels include the department name in parentheses — e.g., 'Grippe (Loire-Atlantique)' instead of just 'Grippe'",
        "When 'France entière' is selected, legend labels show the disease name only (current behavior, e.g., 'Grippe')",
        "The tooltip also reflects the updated label",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 8,
      "passes": true,
      "notes": "The `WastewaterChart` component needs access to the selected department — either via props or by calling `useDepartmentPreferences` internally. The legend label modification is in the `legendEntries` useMemo and `fullChartConfig` useMemo. The department code must be included in the tRPC query key so React Query refetches when it changes."
    },
    {
      "id": "US-030",
      "title": "Sync department selection to URL params",
      "description": "As a user, I want my department selection to be reflected in the URL so that I can share a link that opens the dashboard filtered to a specific department.",
      "acceptanceCriteria": [
        "Add a `dep` URL parameter to `src/hooks/use-url-sync.ts`",
        "When a department is selected, URL includes `dep=44` (the department code); when national is selected, `dep` param is absent or empty",
        "On mount, if `dep` is present in URL params, it overrides the localStorage value",
        "The `useUrlSync` options interface accepts `department: string | null` and `setDepartment: (code: string | null) => void`",
        "`buildSearchString` includes `dep` param when department is not null",
        "`parseDepartmentParam` validates the value is a non-empty string",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Follow the same pattern as the existing URL params (stations, clinical, from, to, hidden). The department param is a simple string, not a comma-separated list."
    }
  ]
}
