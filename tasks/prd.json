{
  "project": "EauxVid",
  "branchName": "ralph/rougeole",
  "description": "Add rougeole (measles) surveillance data from mandatory notifications (Odissé API) with yearly line chart on the home page, department filtering, and a dedicated data info page explaining all data sources.",
  "userStories": [
    {
      "id": "US-060",
      "title": "Fetch rougeole data from Odissé API",
      "description": "As a developer, I need a service to fetch rougeole mandatory notification data from the Odissé API so it can be stored and displayed.",
      "acceptanceCriteria": [
        "Create `src/server/services/rougeole.ts` that fetches from `https://odisse.santepubliquefrance.fr/api/explore/v2.1/catalog/datasets/rougeole-donnees-declaration-obligatoire/exports/json?where=mdo_cl_age_rougeole%3D%22Tous%20%C3%A2ges%22`",
        "Return typed array with fields: `annee` (year string), `dep` (department code), `libgeo` (department name), `tx` (notification rate per 100k), `rou` (case count), `population` (integer)",
        "Handle fetch errors gracefully (throw typed error or return empty array)",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "The Odissé API is the same OpenDataSoft platform used for clinical data. The dataset has ~17,190 records total; filtering to 'Tous âges' server-side reduces to ~1,900 records. Reuse similar fetch patterns from `src/server/services/clinical.ts`. The URL-encoded where clause filters for `mdo_cl_age_rougeole=\"Tous âges\"`. Include `population` in the return type — it's needed later for computing weighted national averages."
    },
    {
      "id": "US-061",
      "title": "Add rougeole table to database schema",
      "description": "As a developer, I need a database table to store rougeole data so it persists and can be queried efficiently.",
      "acceptanceCriteria": [
        "Add `rougeoleIndicatorsTable` to `src/server/db/schema.ts` with columns: `id` (serial PK), `year` (varchar, not null), `department` (varchar, not null, default 'national'), `notification_rate` (doublePrecision, nullable), `cases` (integer, nullable)",
        "Add unique composite index on `(year, department)` using `uniqueIndex`",
        "Run `npm run db:generate` to generate the migration SQL file",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Follow the exact same patterns as existing tables in schema.ts. Use sentinel value 'national' for department (same pattern as clinicalIndicatorsTable). Use `serial` for PK, `varchar` for year/department, `doublePrecision` for notification_rate, `integer` for cases. Import from `drizzle-orm/pg-core`. Use the third argument of `pgTable` (callback returning array of indexes) for the unique index."
    },
    {
      "id": "US-062",
      "title": "Add rougeole sync service and integrate into sync route",
      "description": "As a developer, I need a sync service to upsert rougeole data into the database and integrate it into the existing daily sync pipeline.",
      "acceptanceCriteria": [
        "Create `src/server/services/sync/rougeole-sync.ts` with `syncRougeoleData(db)` function following the pattern from `wastewater-sync.ts` and `clinical-sync.ts`",
        "Fetch data via `fetchRougeoleIndicators()` from `@/server/services/rougeole`",
        "Upsert department-level rows with `onConflictDoUpdate` on `(year, department)` unique key, batch size 500",
        "Compute national totals per year: sum `rou` cases across all departments, compute weighted average `tx` = (total cases / total population) * 100000",
        "Insert national rows with `department = 'national'` sentinel value",
        "Return `{ indicatorsCount: number }` with total rows upserted",
        "Integrate into existing `/api/sync` route: call `syncRougeoleData(db)` alongside wastewater and clinical, track count and errors in sync metadata",
        "Add `rougeole_count` column (integer, default 0) to `syncMetadataTable` in schema.ts and generate migration",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Follow the chunk/batch pattern from existing sync services. Use `sql`excluded.column_name`` for onConflictDoUpdate set values. The national aggregate needs manual computation: group by year, sum cases, sum populations, then rate = (totalCases/totalPopulation)*100000. Update the sync route's result JSON to include rougeoleCount. The sync metadata update should track rougeole_count separately."
    },
    {
      "id": "US-063",
      "title": "Add tRPC router for rougeole data",
      "description": "As a developer, I need a tRPC router to query rougeole data from the database so the frontend can display it.",
      "acceptanceCriteria": [
        "Create `src/server/trpc/routers/rougeole.ts` with a `getIndicators` query procedure",
        "Query accepts optional `department` input param (z.string().optional(), defaults to 'national')",
        "Query the `rougeoleIndicatorsTable` with WHERE `department = input.department ?? 'national'`",
        "Return array of `{ year: string, notificationRate: number | null, cases: number | null }` sorted by year ascending",
        "Map snake_case DB columns: `notification_rate` → `notificationRate`",
        "Register the `rougeoleRouter` in root router at `src/server/trpc/router.ts`",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Follow the exact same pattern as wastewater.ts and clinical.ts routers. Use `publicProcedure` from init.ts. Use `eq`, `asc` from `drizzle-orm`. Import `db` from `@/server/db` and `rougeoleIndicatorsTable` from `@/server/db/schema`. Use `z.object({ department: z.string().optional() })` for input validation."
    },
    {
      "id": "US-064",
      "title": "Rougeole line chart on home page",
      "description": "As a user, I want to see the yearly evolution of rougeole notification rates so I can understand measles trends in France.",
      "acceptanceCriteria": [
        "Create `src/components/rougeole-chart.tsx` as a 'use client' component",
        "Use Recharts `ResponsiveContainer` + `LineChart` with a single `Line` for notification rate",
        "X-axis: years (categorical), Y-axis: notification rate per 100,000 (label: '/100 000 hab.')",
        "Line color: use a red/coral tone (e.g., `hsl(0, 70%, 50%)`) distinct from existing wastewater/clinical colors",
        "Show dots on each data point (`dot={true}`), tooltip showing year and exact rate formatted to 2 decimals",
        "Use tRPC `trpc.rougeole.getIndicators.useQuery()` to fetch data",
        "Show loading skeleton (use existing Skeleton component from shadcn) while data loads",
        "Add the chart as a new section on the home page (`src/app/page.tsx`) BELOW the existing chart+map grid",
        "Section has heading: 'Rougeole — Taux de notification (déclarations obligatoires)'",
        "Wrap in a Card component for visual consistency",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 5,
      "passes": true,
      "notes": "The home page is a 'use client' component at src/app/page.tsx. The existing chart+map section ends around line 100. Add the rougeole section after it. Use the existing department preference from `useDepartmentPreferences()` hook (already used on the page) to pass to the tRPC query. Recharts is already installed. Import Card from '@/components/ui/card'. The chart is simpler than wastewater (single line, no dual Y-axes, no legend grouping)."
    },
    {
      "id": "US-065",
      "title": "Department filtering for rougeole chart",
      "description": "As a user, I want to filter the rougeole chart by department so I can see local measles trends.",
      "acceptanceCriteria": [
        "The rougeole chart reads the current department from the existing `useDepartmentPreferences()` hook (already on the home page)",
        "When a department is selected in the existing DepartmentSelect filter, the rougeole chart updates to show that department's data",
        "When no department is selected (null/undefined), the chart shows national aggregate data (department='national')",
        "The chart heading or a subtitle indicates which department is displayed (e.g., 'France entière' or department name)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 6,
      "passes": true,
      "notes": "The `useDepartmentPreferences()` hook returns `[department, setDepartment]` where department is a string code or null. Pass `department ?? undefined` to the tRPC query. Use `FRENCH_DEPARTMENTS` from constants to look up department name from code. This may already be partially done in US-064 if the chart component reads department state — this story ensures it's properly wired and displays the department name."
    },
    {
      "id": "US-066",
      "title": "Data info/explanation page",
      "description": "As a user, I want a dedicated page explaining all the data sources and metrics so I can understand what the dashboard shows.",
      "acceptanceCriteria": [
        "Create page at `src/app/info/page.tsx` (route: `/info`)",
        "Page is a server component (no 'use client')",
        "Section 1 — Eaux usées: explains SUM'Eau network, viral concentration in wastewater, weekly frequency, link to data.gouv.fr SUM'Eau dataset",
        "Section 2 — Passages aux urgences: explains Odissé/SurSaUD syndromic surveillance, ER visit rate meaning, lists diseases (grippe, bronchiolite, COVID-19), weekly frequency, link to Odissé",
        "Section 3 — Rougeole: explains mandatory notifications (déclarations obligatoires), what 'taux de notification pour 100 000 habitants' means, annual frequency, coverage 2005–2023, underreporting caveat (~56% completeness per 2013 estimate), link to Odissé dataset",
        "Use shadcn Card components for each section with clear headings",
        "All text in French",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 7,
      "passes": false,
      "notes": "This is a static content page — no tRPC queries needed. Use `import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'`. External links should use `target='_blank' rel='noopener noreferrer'`. Keep the tone informative but accessible. Source URLs: SUM'Eau (data.gouv.fr), Odissé (odisse.santepubliquefrance.fr), Rougeole dataset page (odisse.santepubliquefrance.fr/explore/dataset/rougeole-donnees-declaration-obligatoire/)."
    },
    {
      "id": "US-067",
      "title": "Navigation to info page",
      "description": "As a user, I want easy access to the info page from the home page so I can learn about the data.",
      "acceptanceCriteria": [
        "Add a 'À propos des données' link in the header component (`src/components/layout/header.tsx`) using Next.js `Link` to `/info`",
        "Add a small 'En savoir plus sur les données →' link on the home page, near the disclaimer/intro section at the top",
        "Both links use `next/link` for client-side navigation",
        "Header link is styled consistently with existing header elements",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 8,
      "passes": false,
      "notes": "The header is at `src/components/layout/header.tsx` — currently has logo/title + RefreshButton + ThemeToggle. Add the link between the title area and the controls. For the home page link, add it near the disclaimer text (around line 52-61 in page.tsx). Use `import Link from 'next/link'`."
    }
  ]
}
